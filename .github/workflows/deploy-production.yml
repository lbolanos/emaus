name: Deploy to Production

on:
  push:
    branches: [master]

permissions:
  contents: write
  actions: read

jobs:
  # Step 1: Build & Test in GitHub Actions
  build:
    name: Build Application
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install pnpm
        run: npm install -g pnpm

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Run linter
        run: pnpm lint

      - name: Run tests
        run: pnpm test:field-mapping

      - name: Build application
        run: pnpm build

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: build-artifacts
          path: |
            apps/api/dist
            apps/web/dist
          retention-days: 1

  # Step 2: Deploy to EC2
  deploy:
    name: Deploy to EC2
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: build-artifacts
          path: ./build-output

      - name: Deploy to EC2
        env:
          EC2_HOST: ${{ secrets.EC2_HOST }}
          EC2_USER: ${{ secrets.EC2_USER }}
          EC2_SSH_PRIVATE_KEY: ${{ secrets.EC2_SSH_PRIVATE_KEY }}
          DOMAIN_NAME: ${{ secrets.DOMAIN_NAME }}
        run: |
          set -e

          # Setup SSH key
          mkdir -p ~/.ssh
          echo "$EC2_SSH_PRIVATE_KEY" > ~/.ssh/emaus-key.pem
          chmod 600 ~/.ssh/emaus-key.pem

          # Add host key
          ssh-keyscan -H $EC2_HOST >> ~/.ssh/known_hosts 2>/dev/null || true

          # Upload new artifacts (direct copy, no backup due to small instance size)
          scp -i ~/.ssh/emaus-key.pem -r ./build-output/apps/api/dist ubuntu@$EC2_HOST:/var/www/emaus/apps/api/ || true
          scp -i ~/.ssh/emaus-key.pem -r ./build-output/apps/web/dist ubuntu@$EC2_HOST:/var/www/emaus/apps/web/ || true

          # Restart application
          ssh -i ~/.ssh/emaus-key.pem ubuntu@$EC2_HOST << 'RESTARTEOF' || true
          set +e
          cd /var/www/emaus

          echo "Running migrations..."
          pnpm --filter api migration:run 2>&1 | tail -5 || echo "Migrations skipped"

          echo "Restarting PM2..."
          pm2 restart emaus-api
          sleep 5
          pm2 status emaus-api 2>&1 || echo "PM2 status check failed"

          echo "âœ… Deployment complete"
          RESTARTEOF

      - name: Run health checks
        if: success()
        env:
          EC2_HOST: ${{ secrets.EC2_HOST }}
          EC2_USER: ${{ secrets.EC2_USER }}
          EC2_SSH_PRIVATE_KEY: ${{ secrets.EC2_SSH_PRIVATE_KEY }}
        run: |
          mkdir -p ~/.ssh
          echo "$EC2_SSH_PRIVATE_KEY" > ~/.ssh/emaus-key.pem
          chmod 600 ~/.ssh/emaus-key.pem

          ssh-keyscan -H $EC2_HOST >> ~/.ssh/known_hosts 2>/dev/null || true

          # Upload health check script
          scp -i ~/.ssh/emaus-key.pem \
            deploy/aws/health-check.sh \
            $EC2_USER@$EC2_HOST:/tmp/health-check.sh

          # Execute health checks
          ssh -i ~/.ssh/emaus-key.pem \
            $EC2_USER@$EC2_HOST \
            "bash /tmp/health-check.sh"

      - name: Deployment notification
        run: |
          echo "âœ… Deployment Successful!"
          echo "Commit: ${{ github.sha }}"
          echo "Author: ${{ github.actor }}"

      - name: Handle deployment failure
        if: failure()
        env:
          EC2_HOST: ${{ secrets.EC2_HOST }}
          EC2_USER: ${{ secrets.EC2_USER }}
          EC2_SSH_PRIVATE_KEY: ${{ secrets.EC2_SSH_PRIVATE_KEY }}
        run: |
          echo "âŒ Deployment failed. Checking EC2 status..."

          mkdir -p ~/.ssh
          echo "$EC2_SSH_PRIVATE_KEY" > ~/.ssh/emaus-key.pem
          chmod 600 ~/.ssh/emaus-key.pem

          ssh-keyscan -H $EC2_HOST >> ~/.ssh/known_hosts 2>/dev/null || true

          # Attempt to get diagnostic information
          ssh -i ~/.ssh/emaus-key.pem \
            $EC2_USER@$EC2_HOST \
            "pm2 status; echo '---'; tail -50 /tmp/deployment.log 2>/dev/null || echo 'Deployment log not found'" \
            2>&1 || echo "Could not retrieve diagnostic info"

      - name: Upload deployment artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: deployment-logs
          path: artifacts/
          retention-days: 30

  # Step 3: Deployment summary
  deployment-summary:
    name: Deployment Summary
    runs-on: ubuntu-latest
    needs: deploy
    if: always()
    steps:
      - name: Generate summary
        run: |
          echo "## ðŸš€ Production Deployment Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Field | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Commit | [\`${{ github.sha }}\`](${{ github.server_url }}/${{ github.repository }}/commit/${{ github.sha }}) |" >> $GITHUB_STEP_SUMMARY
          echo "| Author | ${{ github.actor }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Status | ${{ needs.deploy.result == 'success' && 'âœ… Success' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Timestamp | $(date -u +'%Y-%m-%d %H:%M:%S UTC') |" >> $GITHUB_STEP_SUMMARY
          echo "| Environment | https://${{ secrets.DOMAIN_NAME }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ needs.deploy.result }}" = "success" ]; then
            echo "### âœ… Deployment Successful" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "The application has been successfully deployed to production with S3 multi-purpose bucket support." >> $GITHUB_STEP_SUMMARY
          else
            echo "### âŒ Deployment Failed" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "The deployment encountered an error. Please review the [workflow logs](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})" >> $GITHUB_STEP_SUMMARY
          fi
