name: Deploy to Production

on:
  push:
    branches: [master]

permissions:
  contents: write
  actions: read

jobs:
  # Step 1: Build & Test in GitHub Actions
  build:
    name: Build Application
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install pnpm
        run: npm install -g pnpm

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Run linter
        run: pnpm lint

      - name: Run tests
        run: pnpm test:field-mapping

      - name: Build application
        run: pnpm build

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: build-artifacts
          path: apps
          retention-days: 1

  # Step 2: Deploy to EC2
  deploy:
    name: Deploy to EC2
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: build-artifacts
          path: ./build-output

      - name: Deploy to EC2
        env:
          EC2_HOST: ${{ secrets.EC2_HOST }}
          EC2_USER: ${{ secrets.EC2_USER }}
          EC2_SSH_PRIVATE_KEY: ${{ secrets.EC2_SSH_PRIVATE_KEY }}
          DOMAIN_NAME: ${{ secrets.DOMAIN_NAME }}
        run: |
          set -e

          # Setup SSH key
          mkdir -p ~/.ssh
          echo "$EC2_SSH_PRIVATE_KEY" > ~/.ssh/emaus-key.pem
          chmod 600 ~/.ssh/emaus-key.pem

          # Add host key
          ssh-keyscan -H $EC2_HOST >> ~/.ssh/known_hosts 2>/dev/null || true

          # List build output structure for debugging
          echo "Build output structure:"
          find ./build-output -maxdepth 3 -type d | head -20

          # Upload new artifacts
          echo "Uploading API build..."
          if [ -d "./build-output/api/dist" ]; then
            scp -i ~/.ssh/emaus-key.pem -r ./build-output/api/dist ubuntu@$EC2_HOST:/var/www/emaus/apps/api/
          elif [ -d "./build-output/apps/api/dist" ]; then
            scp -i ~/.ssh/emaus-key.pem -r ./build-output/apps/api/dist ubuntu@$EC2_HOST:/var/www/emaus/apps/api/
          else
            echo "Warning: API dist not found, looking for alternatives..."
            find ./build-output -name "index.js" -path "*/api/dist/*"
          fi

          echo "Uploading Web build..."
          if [ -d "./build-output/web/dist" ]; then
            scp -i ~/.ssh/emaus-key.pem -r ./build-output/web/dist ubuntu@$EC2_HOST:/var/www/emaus/apps/web/
          elif [ -d "./build-output/apps/web/dist" ]; then
            scp -i ~/.ssh/emaus-key.pem -r ./build-output/apps/web/dist ubuntu@$EC2_HOST:/var/www/emaus/apps/web/
          else
            echo "Warning: Web dist not found"
          fi

          # Deploy and restart application
          ssh -i ~/.ssh/emaus-key.pem ubuntu@$EC2_HOST << 'RESTARTEOF'
          set -e
          cd /var/www/emaus

          echo "Installing dependencies..."
          pnpm install --frozen-lockfile 2>&1 | tail -10

          echo "Running migrations..."
          pnpm --filter api migration:run 2>&1 | tail -5 || echo "Migrations skipped"

          echo "Restarting PM2..."
          pm2 restart emaus-api
          sleep 3

          echo "Checking PM2 status..."
          pm2 status emaus-api

          RESTARTEOF

      - name: Run health checks
        if: success()
        env:
          EC2_HOST: ${{ secrets.EC2_HOST }}
          EC2_USER: ${{ secrets.EC2_USER }}
          EC2_SSH_PRIVATE_KEY: ${{ secrets.EC2_SSH_PRIVATE_KEY }}
        run: |
          set -e

          mkdir -p ~/.ssh
          echo "$EC2_SSH_PRIVATE_KEY" > ~/.ssh/emaus-key.pem
          chmod 600 ~/.ssh/emaus-key.pem

          ssh-keyscan -H $EC2_HOST >> ~/.ssh/known_hosts 2>/dev/null || true

          echo "Uploading health check script..."
          scp -i ~/.ssh/emaus-key.pem \
            deploy/aws/health-check.sh \
            $EC2_USER@$EC2_HOST:/tmp/health-check.sh

          echo "Running health checks..."
          ssh -i ~/.ssh/emaus-key.pem \
            $EC2_USER@$EC2_HOST \
            "bash /tmp/health-check.sh"

          echo "Health checks passed! âœ…"

      - name: Quick API validation
        if: success()
        env:
          DOMAIN_NAME: ${{ secrets.DOMAIN_NAME }}
        run: |
          echo "Validating API is responding..."
          sleep 5

          # Try to reach the health endpoint
          for i in {1..5}; do
            RESPONSE=$(curl -s -w "\n%{http_code}" https://${DOMAIN_NAME}/api/health || echo -e "\n000")
            HTTP_CODE=$(echo "$RESPONSE" | tail -1)

            if [ "$HTTP_CODE" = "200" ] || [ "$HTTP_CODE" = "302" ]; then
              echo "âœ… API is responding (HTTP $HTTP_CODE)"
              exit 0
            fi

            echo "Attempt $i: HTTP $HTTP_CODE - retrying..."
            sleep 2
          done

          echo "âŒ API validation failed"
          exit 1

      - name: Deployment notification
        run: |
          echo "âœ… Deployment Successful!"
          echo "Commit: ${{ github.sha }}"
          echo "Author: ${{ github.actor }}"
          echo "Application: https://${{ secrets.DOMAIN_NAME }}"

      - name: Handle deployment failure
        if: failure()
        env:
          EC2_HOST: ${{ secrets.EC2_HOST }}
          EC2_USER: ${{ secrets.EC2_USER }}
          EC2_SSH_PRIVATE_KEY: ${{ secrets.EC2_SSH_PRIVATE_KEY }}
        run: |
          echo "âŒ Deployment failed. Checking EC2 status..."

          mkdir -p ~/.ssh
          echo "$EC2_SSH_PRIVATE_KEY" > ~/.ssh/emaus-key.pem
          chmod 600 ~/.ssh/emaus-key.pem

          ssh-keyscan -H $EC2_HOST >> ~/.ssh/known_hosts 2>/dev/null || true

          # Attempt to get diagnostic information
          ssh -i ~/.ssh/emaus-key.pem \
            $EC2_USER@$EC2_HOST \
            "pm2 status; echo '---'; tail -50 /tmp/deployment.log 2>/dev/null || echo 'Deployment log not found'" \
            2>&1 || echo "Could not retrieve diagnostic info"

      - name: Upload deployment artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: deployment-logs
          path: artifacts/
          retention-days: 30

  # Step 3: Deployment summary
  deployment-summary:
    name: Deployment Summary
    runs-on: ubuntu-latest
    needs: deploy
    if: always()
    steps:
      - name: Generate summary
        run: |
          echo "## ðŸš€ Production Deployment Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Field | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Commit | [\`${{ github.sha }}\`](${{ github.server_url }}/${{ github.repository }}/commit/${{ github.sha }}) |" >> $GITHUB_STEP_SUMMARY
          echo "| Author | ${{ github.actor }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Status | ${{ needs.deploy.result == 'success' && 'âœ… Success' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Timestamp | $(date -u +'%Y-%m-%d %H:%M:%S UTC') |" >> $GITHUB_STEP_SUMMARY
          echo "| Environment | https://${{ secrets.DOMAIN_NAME }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ needs.deploy.result }}" = "success" ]; then
            echo "### âœ… Deployment Successful" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "The application has been successfully deployed to production with S3 multi-purpose bucket support." >> $GITHUB_STEP_SUMMARY
          else
            echo "### âŒ Deployment Failed" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "The deployment encountered an error. Please review the [workflow logs](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})" >> $GITHUB_STEP_SUMMARY
          fi
