<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="description" content="Emaus Runtime Configuration Test">
    <title>Runtime Configuration Test - Emaus</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            border-radius: 8px;
            padding: 30px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #2c3e50;
            border-bottom: 3px solid #3498db;
            padding-bottom: 15px;
        }
        .test-section {
            margin: 20px 0;
            padding: 20px;
            border: 1px solid #e1e5e9;
            border-radius: 6px;
            background-color: #fafbfc;
        }
        .status-indicator {
            display: inline-block;
            padding: 6px 12px;
            border-radius: 20px;
            font-weight: bold;
            font-size: 14px;
            margin: 5px 0;
        }
        .success { background-color: #d4edda; color: #155724; }
        .warning { background-color: #fff3cd; color: #856404; }
        .error { background-color: #f8d7da; color: #721c24; }
        .info { background-color: #d1ecf1; color: #0c5460; }
        .config-value {
            font-family: 'Monaco', 'Menlo', monospace;
            background: #f8f9fa;
            padding: 10px;
            border-radius: 4px;
            border-left: 4px solid #3498db;
            margin: 10px 0;
            word-break: break-all;
        }
        button {
            background: #3498db;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
            font-size: 14px;
        }
        button:hover {
            background: #2980b9;
        }
        button:active {
            transform: translateY(1px);
        }
        .button-group {
            margin: 20px 0;
        }
        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }
        @media (max-width: 768px) {
            .grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üß™ Emaus Runtime Configuration Test</h1>

        <div class="test-section">
            <h2>üìã What This Tests</h2>
            <p>This page tests the <strong>runtime configuration system</strong> that allows the same build artifact to work across different environments without rebuilds.</p>

            <div class="grid">
                <div>
                    <h3>üîß Features Tested:</h3>
                    <ul>
                        <li><strong>Environment Detection</strong> - Auto-detects dev/staging/production</li>
                        <li><strong>Runtime Configuration</strong> - Loads settings dynamically</li>
                        <li><strong>API URL Resolution</strong> - Uses correct endpoint per environment</li>
                        <li><strong>Google Maps Integration</strong> - API key availability check</li>
                        <li><strong>Runtime Updates</strong> - Test configuration changes</li>
                    </ul>
                </div>

                <div>
                    <h3>üéØ Use Cases:</h3>
                    <ul>
                        <li><strong>Development</strong> - Verify localhost configuration</li>
                        <li><strong>Staging</strong> - Test staging environment detection</li>
                        <li><strong>Production</strong> - Validate production settings</li>
                        <li><strong>Debugging</strong> - Troubleshoot configuration issues</li>
                        <li><strong>Testing</strong> - Verify environment variable loading</li>
                    </ul>
                </div>
            </div>
        </div>

        <div id="test-results">
            <h2>üîÑ Testing Runtime Configuration...</h2>
            <div class="status-indicator info">Loading configuration...</div>
        </div>

        <div class="test-section" id="configuration-display" style="display: none;">
            <h2>‚úÖ Configuration Loaded Successfully!</h2>

            <div class="grid">
                <div>
                    <h3>üåê Environment</h3>
                    <div class="config-value" id="env-display">Loading...</div>
                </div>

                <div>
                    <h3>üîó API URL</h3>
                    <div class="config-value" id="api-url-display">Loading...</div>
                </div>
            </div>

            <div class="grid">
                <div>
                    <h3>üó∫Ô∏è Development Mode</h3>
                    <div class="status-indicator" id="dev-status">Loading...</div>
                </div>

                <div>
                    <h3>üöÄ Production Mode</h3>
                    <div class="status-indicator" id="prod-status">Loading...</div>
                </div>
            </div>

            <div class="grid">
                <div>
                    <h3>üó∫Ô∏è Staging Mode</h3>
                    <div class="status-indicator" id="staging-status">Loading...</div>
                </div>

                <div>
                    <h3>üó∫Ô∏è Google Maps API</h3>
                    <div class="status-indicator" id="maps-status">Loading...</div>
                    <div class="config-value" id="maps-key-display">Loading...</div>
                </div>
            </div>
        </div>

        <div class="test-section" id="test-controls" style="display: none;">
            <h2>üß™ Interactive Tests</h2>

            <div class="button-group">
                <button onclick="testEnvironmentDetection()">üîç Test Environment Detection</button>
                <button onclick="testConfigUpdate()">üîÑ Test Configuration Update</button>
                <button onclick="testConfigReload()">üîÉ Test Configuration Reload</button>
            </div>

            <div class="button-group">
                <button onclick="switchToDevelopment()">üè† Switch to Development</button>
                <button onclick="switchToStaging()">üöß Switch to Staging</button>
                <button onclick="switchToProduction()">üöÄ Switch to Production</button>
            </div>
        </div>

        <div class="test-section">
            <h2>üìö Purpose & Usage</h2>
            <div class="grid">
                <div>
                    <h3>üéØ Why This Exists:</h3>
                    <ul>
                        <li><strong>Debugging</strong> - Verify configuration loading works</li>
                        <li><strong>Testing</strong> - Validate environment detection logic</li>
                        <li><strong>Deployment</strong> - Confirm production settings are correct</li>
                        <li><strong>Development</strong> - Test local configuration changes</li>
                    </ul>
                </div>

                <div>
                    <h3>üîß How to Use:</h3>
                    <ol>
                        <li><strong>Build the app:</strong> <code>pnpm build</code></li>
                        <li><strong>Start server:</strong> <code>python3 -m http.server 8080</code></li>
                        <li><strong>Open test:</strong> <code>http://localhost:8080/test-config.html</code></li>
                        <li><strong>Check results:</strong> Review configuration status</li>
                        <li><strong>Test changes:</strong> Use interactive buttons</li>
                    </ol>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        // Import the runtime config
        import('./apps/web/dist/runtime-config.js')
            .catch(err => console.error('Failed to load runtime config:', err));

        // Test the configuration
        window.addEventListener('load', () => {
            runConfigurationTest();
        });

        function runConfigurationTest() {
            const config = window.getEmausConfig?.();
            const resultsDiv = document.getElementById('test-results');
            const configDisplay = document.getElementById('configuration-display');

            if (config) {
                // Show success and configuration details
                resultsDiv.innerHTML = `
                    <h2>‚úÖ Configuration Loaded Successfully!</h2>
                    <div class="status-indicator success">Runtime configuration is working</div>
                `;

                // Display configuration details
                displayConfiguration(config);

                // Show test controls
                document.getElementById('test-controls').style.display = 'block';
                document.getElementById('configuration-display').style.display = 'block';

                console.log('[TEST] Configuration test passed:', config);
            } else {
                // Show error
                resultsDiv.innerHTML = `
                    <h2>‚ùå Configuration Failed to Load</h2>
                    <div class="status-indicator error">
                        <strong>Error:</strong> window.getEmausConfig is not available<br>
                        <strong>Cause:</strong> Runtime configuration module not loaded<br>
                        <strong>Solution:</strong> Check that apps/web/dist/runtime-config.js exists and is accessible
                    </div>
                `;

                console.error('[TEST] Configuration test failed - window.getEmausConfig not available');
            }
        }

        function displayConfiguration(config) {
            // Environment
            document.getElementById('env-display').textContent = config.environment || 'unknown';

            // API URL
            document.getElementById('api-url-display').textContent = config.apiUrl || 'undefined';

            // Development status
            const devStatus = document.getElementById('dev-status');
            if (config.isDevelopment) {
                devStatus.textContent = 'YES';
                devStatus.className = 'status-indicator success';
            } else {
                devStatus.textContent = 'NO';
                devStatus.className = 'status-indicator error';
            }

            // Production status
            const prodStatus = document.getElementById('prod-status');
            if (config.isProduction) {
                prodStatus.textContent = 'YES';
                prodStatus.className = 'status-indicator success';
            } else {
                prodStatus.textContent = 'NO';
                prodStatus.className = 'status-indicator error';
            }

            // Staging status
            const stagingStatus = document.getElementById('staging-status');
            if (config.isStaging) {
                stagingStatus.textContent = 'YES';
                stagingStatus.className = 'status-indicator success';
            } else {
                stagingStatus.textContent = 'NO';
                stagingStatus.className = 'status-indicator error';
            }

            // Google Maps status
            const mapsStatus = document.getElementById('maps-status');
            const mapsKeyDisplay = document.getElementById('maps-key-display');

            if (config.googleMapsApiKey) {
                mapsStatus.textContent = 'AVAILABLE';
                mapsStatus.className = 'status-indicator success';
                mapsKeyDisplay.textContent = config.googleMapsApiKey.substring(0, 10) + '...'; // Show first 10 chars for security
            } else {
                mapsStatus.textContent = 'MISSING';
                mapsStatus.className = 'status-indicator warning';
                mapsKeyDisplay.textContent = 'Not configured';
            }
        }

        function testEnvironmentDetection() {
            const hostname = window.location.hostname;
            const port = window.location.port;

            alert(`Environment Detection Test:\n` +
                  `Hostname: ${hostname}\n` +
                  `Port: ${port}\n` +
                  `URL: ${window.location.href}\n\n` +
                  `This should be detected as: ${window.getEmausConfig()?.environment || 'unknown'}`);
        }

        function testConfigUpdate() {
            try {
                window.updateEmausConfig({
                    testMode: 'enabled',
                    lastUpdated: new Date().toISOString()
                });

                // Refresh display
                displayConfiguration(window.getEmausConfig());

                alert('‚úÖ Configuration updated successfully!\nCheck the console for details.');
                console.log('[TEST] Configuration update test passed:', window.getEmausConfig());
            } catch (error) {
                alert('‚ùå Configuration update failed!\n' + error.message);
                console.error('[TEST] Configuration update test failed:', error);
            }
        }

        function testConfigReload() {
            // This would typically reload the page or reinitialize config
            alert('Configuration reload test\n' +
                  'In a real app, this would reload the configuration from sources.\n' +
                  'For this test, just check the console for reload events.');

            console.log('[TEST] Configuration reload test initiated');
        }

        function switchToDevelopment() {
            window.updateEmausConfig({
                environment: 'development',
                isDevelopment: true,
                isProduction: false,
                isStaging: false,
                apiUrl: 'http://localhost:3001/api'
            });
            displayConfiguration(window.getEmausConfig());
            alert('üè† Switched to Development configuration!\nAPI URL: http://localhost:3001/api');
        }

        function switchToStaging() {
            window.updateEmausConfig({
                environment: 'staging',
                isDevelopment: false,
                isProduction: false,
                isStaging: true,
                apiUrl: 'https://staging.emaus.cc/api'
            });
            displayConfiguration(window.getEmausConfig());
            alert('üöß Switched to Staging configuration!\nAPI URL: https://staging.emaus.cc/api');
        }

        function switchToProduction() {
            window.updateEmausConfig({
                environment: 'production',
                isDevelopment: false,
                isProduction: true,
                isStaging: false,
                apiUrl: 'https://emaus.cc/api'
            });
            displayConfiguration(window.getEmausConfig());
            alert('üöÄ Switched to Production configuration!\nAPI URL: https://emaus.cc/api');
        }
    </script>
</body>
</html>